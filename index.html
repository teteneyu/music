<!DOCTYPE html><html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FM Retro â€” Textâ†’MIDIâ†’Preview (Mobile)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
<script src="https://cdn.jsdelivr.net/npm/midiwriter-js@latest/dist/MidiWriter.min.js"></script>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN',"Noto Sans JP",sans-serif;padding:16px;background:#0b1020;color:#e6eef8}
  .card{background:#0f1724;padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.6);}
  textarea{width:100%;min-height:96px;padding:10px;border-radius:8px;border:none;background:#081026;color:inherit}
  button{padding:10px 12px;border-radius:8px;border:none;background:#3b82f6;color:#fff;font-weight:600}
  .row{display:flex;gap:8px;align-items:center;margin:8px 0}
  select,input{padding:8px;border-radius:8px;border:none;background:#081026;color:inherit}
  small{color:#9fb0d8}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
</style>
</head>
<body>
<div class="card">
  <h2>FM Retro â€” Text â†’ MIDI â†’ Preview</h2>
  <p style="margin:0 0 8px 0"><small>ã‚¹ãƒãƒ›å‘ã‘ã«æœ€å°ãƒ»ç¢ºå®Ÿãªæ©Ÿèƒ½ã ã‘æ®‹ã—ãŸç°¡æ˜“éŸ³æºã€‚éŸ³ãŒé³´ã‚‰ãªã„æ™‚ã¯å¿…ãšã€Œå†ç”Ÿã€ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã®éŸ³å£°å†ç”Ÿæ¨©é™ã‚’èµ·å‹•ã—ã¦ã­ã€‚</small></p><label><small>ã‚³ãƒ¼ãƒ‰é€²è¡Œï¼ˆãƒãƒ¼ã¯ | ã§åŒºåˆ‡ã‚‹ï¼‰</small></label>

  <textarea id="prog">Cmaj7 | Am7 D7 | Gmaj7 | Em7 A7 | Dmaj7</textarea>  <div class="row">
    <label><small>ãƒ†ãƒ³ãƒ</small></label>
    <input id="tempo" type="number" value="100" style="width:88px" />
    <label><small>ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–</small></label>
    <select id="octave"><option>3</option><option selected>4</option><option>5</option></select>
    <label><small>1ã‚³ãƒ¼ãƒ‰ã®é•·ã•</small></label>
    <select id="beats"><option value="1">1æ‹ (4n)</option><option value="2">2æ‹ (2n)</option><option value="4">4æ‹ (1m)</option></select>
  </div>  <div class="row controls">
    <button id="play">â–¶ å†ç”Ÿ</button>
    <button id="stop">â–  åœæ­¢</button>
    <button id="loop">ğŸ” ãƒ«ãƒ¼ãƒ—: OFF</button>
    <button id="midi">â¬‡ MIDI DL</button>
    <button id="rec">â— éŒ²éŸ³</button>
  </div>  <div style="margin-top:8px">
    <label><small>FM ãƒ—ãƒªã‚»ãƒƒãƒˆ</small></label>
    <select id="preset">
      <option value="chip">Chip (bright bell)</option>
      <option value="pad">Pad (soft pad)</option>
      <option value="bass">Bass (FM bass)</option>
    </select>
  </div>  <div style="margin-top:12px">
    <label><small>SUNOç”¨è‡ªå‹•ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</small></label>
    <div class="row"><button id="gen">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ</button></div>
    <textarea id="prompt" style="min-height:96px">Instrumental retro-FM game track. Tempo 100 BPM. Chord progression: Cmaj7 | Am7 D7 | Gmaj7 | Em7 A7 | Dmaj7. Style: nostalgic, catchy, metallic FM bells + soft FM pad. Loop-friendly 8 bars. No vocals.</textarea>
  </div>  <div style="margin-top:10px"><audio id="player" controls style="width:100%"></audio></div>
  <p style="margin-top:12px"><small>å•é¡ŒãŒã‚ã‚Œã°ã“ã®ç”»é¢ã®ã¾ã¾æ“ä½œã—ã¦æ•™ãˆã¦ã€‚ã‚³ãƒ¼ãƒ‰ã¯1ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆindex.htmlï¼‰ã ã‹ã‚‰ã‚¹ãƒãƒ›ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰â†’GitHub Pageså…¬é–‹ãŒã‚ã£ã¡ã‚ƒæ¥½ã€‚</small></p>
</div><script>
// --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
const noteNames = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const noteToSemitone = {C:0,'C#':1,Db:1,D:2,'D#':3,Eb:3,E:4,F:5,'F#':6,Gb:6,G:7,'G#':8,Ab:8,A:9,'A#':10,Bb:10,B:11};

function parseProg(text){
  return text.split('|').flatMap(bar=>bar.trim().split(/[ ,]+/).filter(Boolean));
}
function chordToMidi(chord, octave=4){
  const m = chord.match(/^[A-G](#|b)?/); if(!m) return [];
  const root = m[0]; const quality = chord.slice(root.length).toLowerCase();
  const semitone = noteToSemitone[root];
  const base = 12*(octave+1) + semitone;
  let ints = [0,4,7];
  if(quality.startsWith('m') && !quality.startsWith('maj')) ints=[0,3,7];
  if(quality.includes('maj7')) ints=[0,4,7,11];
  if(quality.includes('m7')) ints=[0,3,7,10];
  if(quality==='7') ints=[0,4,7,10];
  if(quality.includes('sus2')) ints=[0,2,7];
  if(quality.includes('sus4')) ints=[0,5,7];
  if(quality.includes('9')) ints=[0,4,7,14];
  return ints.map(i=>base+i);
}
function midiToNoteName(midi){
  const oct = Math.floor(midi/12)-1; const nn = noteNames[midi%12]; return nn+oct;
}

// --- Tone / synth setup ---
let synth = null; // PolySynth
let master = null; // Gain node to route to recorder+destination
let recorder = null;
let part = null; // Tone.Part
let isLoop = false;
let isRecording = false;

function createSynth(preset){
  // dispose if exists
  if(synth){ synth.dispose(); master.dispose(); recorder=null; }
  // master gain
  master = new Tone.Gain(0.9).toDestination();
  // recorder attached to master
  recorder = new Tone.Recorder();
  master.connect(recorder);

  // poly synth of FMSynth
  const commonOpts = {harmonicity:1.5,modulationIndex:8,envelope:{attack:0.01,decay:0.2,sustain:0.7,release:0.6}};
  let opts = Object.assign({}, commonOpts);
  if(preset==='chip') { opts.harmonicity = 2.5; opts.modulationIndex = 14; }
  if(preset==='pad')  { opts.harmonicity = 0.8; opts.modulationIndex = 6; opts.envelope = {attack:0.6,decay:1.2,sustain:0.6,release:1.4}; }
  if(preset==='bass') { opts.harmonicity = 0.5; opts.modulationIndex = 18; opts.envelope = {attack:0.01,decay:0.4,sustain:0.8,release:0.8}; }

  synth = new Tone.PolySynth(Tone.FMSynth, {maxPolyphony:6, voice: opts}).connect(master);
}

// --- Playback ---
function buildPart(){
  const prog = parseProg(document.getElementById('prog').value);
  const tempo = Number(document.getElementById('tempo').value) || 100;
  const octave = Number(document.getElementById('octave').value) || 4;
  const beatsPerChord = Number(document.getElementById('beats').value) || 1;

  // dispose old part
  if(part){ part.stop(); part.dispose(); part = null; }

  Tone.Transport.bpm.value = tempo;

  const events = [];
  prog.forEach((ch, i) => {
    const midiNotes = chordToMidi(ch, octave);
    if(midiNotes.length===0) return;
    const noteNames = midiNotes.map(m=>midiToNoteName(m));
    // compute transport time string: bars:quarters:sixteenths
    const beats = i * beatsPerChord; // counts of quarter-note beats from start
    const bars = Math.floor(beats / 4);
    const quarters = Math.floor(beats % 4);
    const timeStr = `${bars}:${quarters}:0`;
    events.push({time: timeStr, notes: noteNames, duration: beatsPerChord===1? '4n' : beatsPerChord===2? '2n':'1m'});
  });

  part = new Tone.Part((time, value) => {
    synth.triggerAttackRelease(value.notes, value.duration, time);
  }, events);

  // loop handling: set loopEnd to length in measures
  if(isLoop && events.length>0){
    // compute end bars
    const lastBeats = (events.length) * Number(document.getElementById('beats').value);
    const endBars = Math.ceil(lastBeats/4);
    part.loop = true; part.loopEnd = `${endBars}m`;
  } else {
    part.loop = false;
  }
}

async function startPlay(){
  // ensure audio started (user gesture)
  await Tone.start();
  // create synth if null
  if(!synth) createSynth(document.getElementById('preset').value);
  buildPart();
  part.start(0);
  Tone.Transport.start();
  document.getElementById('play').disabled = true;
}
function stopPlay(){
  Tone.Transport.stop();
  if(part){ part.stop(); part.dispose(); part = null; }
  document.getElementById('play').disabled = false;
}

// --- MIDI export ---
function exportMIDI(){
  const prog = parseProg(document.getElementById('prog').value);
  const tempo = Number(document.getElementById('tempo').value) || 100;
  const octave = Number(document.getElementById('octave').value) || 4;
  const track = new MidiWriter.Track(); track.setTempo(tempo);
  prog.forEach(ch => {
    const midi = chordToMidi(ch, octave);
    if(midi.length===0) return;
    const names = midi.map(m=>midiToNoteName(m));
    track.addEvent(new MidiWriter.ChordEvent({pitch: names, duration: '4'}));
  });
  const writer = new MidiWriter.Writer(track);
  const blob = new Blob([writer.buildFile()], {type:'audio/midi'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'progression.mid'; a.click();
}

// --- Recorder (WAV) ---
async function startRecording(){
  if(!synth) createSynth(document.getElementById('preset').value);
  await Tone.start();
  recorder.start();
  isRecording = true;
  document.getElementById('rec').textContent = 'â–  éŒ²éŸ³ä¸­';
  startPlay();
}
async function stopRecording(){
  if(!isRecording) return;
  const recording = await recorder.stop(); // Blob
  const url = URL.createObjectURL(recording);
  document.getElementById('player').src = url;
  isRecording = false;
  document.getElementById('rec').textContent = 'â— éŒ²éŸ³';
  stopPlay();
}

// --- Prompt gen ---
function genPrompt(){
  const tempo = Number(document.getElementById('tempo').value)||100;
  const prog = document.getElementById('prog').value.trim();
  const preset = document.getElementById('preset').value;
  const mood = preset==='chip'? 'bright nostalgic':'lush and warm';
  const txt = `Instrumental retro-FM game track. Tempo ${tempo} BPM. Chord progression: ${prog}. Style: ${mood}, metallic FM bells, tight bass, loop-friendly. No vocals.`;
  document.getElementById('prompt').value = txt;
}

// --- Event wiring ---
document.getElementById('play').addEventListener('click', async ()=>{ try{ await startPlay(); }catch(e){ alert('å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸï¼š'+e.message); }});
document.getElementById('stop').addEventListener('click', ()=>stopPlay());
document.getElementById('midi').addEventListener('click', ()=>exportMIDI());
document.getElementById('rec').addEventListener('click', async ()=>{
  if(!isRecording) await startRecording(); else await stopRecording();
});
document.getElementById('gen').addEventListener('click', ()=>genPrompt());
document.getElementById('loop').addEventListener('click', ()=>{ isLoop = !isLoop; document.getElementById('loop').textContent = `ğŸ” ãƒ«ãƒ¼ãƒ—: ${isLoop? 'ON':'OFF'}`; try{ buildPart(); }catch(e){} });

// ensure presets recreate synth
document.getElementById('preset').addEventListener('change', ()=>{ if(synth){ synth.dispose(); synth=null; createSynth(document.getElementById('preset').value); }});

</script></body>
</html>
