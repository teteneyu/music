<!DOCTYPE html><html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FM Retro â€” Textâ†’MIDIâ†’Preview (Mobile)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
<script src="https://cdn.jsdelivr.net/npm/midiwriter-js@latest/dist/MidiWriter.min.js"></script>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN',"Noto Sans JP",sans-serif;padding:16px;background:#0b1020;color:#e6eef8}
  .card{background:#0f1724;padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.6);}
  textarea{width:100%;min-height:96px;padding:10px;border-radius:8px;border:none;background:#081026;color:inherit}
  button{padding:10px 12px;border-radius:8px;border:none;background:#3b82f6;color:#fff;font-weight:600}
  .row{display:flex;gap:8px;align-items:center;margin:8px 0}
  select,input{padding:8px;border-radius:8px;border:none;background:#081026;color:inherit}
  small{color:#9fb0d8}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
</style>
</head>
<body>
<div class="card">
  <h2>FM Retro â€” Text â†’ MIDI â†’ Preview</h2>
  <p style="margin:0 0 8px 0"><small>ã‚¹ãƒãƒ›å‘ã‘ã«æœ€å°ãƒ»ç¢ºå®Ÿãªæ©Ÿèƒ½ã ã‘æ®‹ã—ãŸç°¡æ˜“éŸ³æºã€‚éŸ³ãŒé³´ã‚‰ãªã„æ™‚ã¯å¿…ãšã€Œå†ç”Ÿã€ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã®éŸ³å£°å†ç”Ÿæ¨©é™ã‚’èµ·å‹•ã—ã¦ã­ã€‚</small></p><label><small>ã‚³ãƒ¼ãƒ‰é€²è¡Œï¼ˆãƒãƒ¼ã¯ | ã§åŒºåˆ‡ã‚‹ï¼‰</small></label>

  <textarea id="prog">Cmaj7 | Am7 D7 | Gmaj7 | Em7 A7 | Dmaj7</textarea>  <div class="row">
    <label><small>ãƒ†ãƒ³ãƒ</small></label>
    <input id="tempo" type="number" value="100" style="width:88px" />
    <label><small>ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–</small></label>
    <select id="octave"><option>3</option><option selected>4</option><option>5</option></select>
    <label><small>1ã‚³ãƒ¼ãƒ‰ã®é•·ã•</small></label>
    <select id="beats"><option value="1">1æ‹ (4n)</option><option value="2">2æ‹ (2n)</option><option value="4">4æ‹ (1m)</option></select>
  </div>  <div class="row controls">
    <button id="play">â–¶ å†ç”Ÿ</button>
    <button id="stop">â–  åœæ­¢</button>
    <button id="loop">ğŸ” ãƒ«ãƒ¼ãƒ—: OFF</button>
    <button id="midi">â¬‡ MIDI DL</button>
    <button id="rec">â— éŒ²éŸ³</button>
  </div>  <div style="margin-top:8px">
    <label><small>FM ãƒ—ãƒªã‚»ãƒƒãƒˆ</small></label>
    <select id="preset">
      <option value="chip">Chip (bright bell)</option>
      <option value="pad">Pad (soft pad)</option>
      <option value="bass">Bass (FM bass)</option>
      <option value="piano">Piano-like (FM EP)</option>
      <option value="guitar">Guitar-ish (plucked FM)</option>
      <option value="bell">Bell (FM metallic)</option>
    </select>
  </div>  <div style="margin-top:12px">
    <label><small>SUNOç”¨è‡ªå‹•ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</small></label>
    <div class="row"><button id="gen">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ</button></div>
    <textarea id="prompt" style="min-height:96px">Instrumental retro-FM game track. Tempo 100 BPM. Chord progression: Cmaj7 | Am7 D7 | Gmaj7 | Em7 A7 | Dmaj7. Style: nostalgic, catchy, metallic FM bells + soft FM pad. Loop-friendly 8 bars. No vocals.</textarea>
  </div>  <div style="margin-top:10px"><audio id="player" controls style="width:100%"></audio></div>
  <p style="margin-top:12px"><small>å•é¡ŒãŒã‚ã‚Œã°ã“ã®ç”»é¢ã®ã¾ã¾æ“ä½œã—ã¦æ•™ãˆã¦ã€‚ã‚³ãƒ¼ãƒ‰ã¯1ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆindex.htmlï¼‰ã ã‹ã‚‰ã‚¹ãƒãƒ›ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰â†’GitHub Pageså…¬é–‹ãŒã‚ã£ã¡ã‚ƒæ¥½ã€‚</small></p>
</div><script>
// --- FIXES & CLEANUP PASS v2 ---
// 1. Prevent undefined variables & duplicated preset maps
// 2. Normalize preset definitions into one map
// 3. Ensure recorder / synth / part are globally defined
// 4. Remove unused functions & unify structure
// 5. Add safety checks for canvas redraw
let synth, part, recorder, master;

// --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
const noteNames = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const noteToSemitone = {C:0,'C#':1,Db:1,D:2,'D#':3,Eb:3,E:4,F:5,'F#':6,Gb:6,G:7,'G#':8,Ab:8,A:9,'A#':10,Bb:10,B:11};

function parseProg(text){
  return text.split('|').flatMap(bar=>bar.trim().split(/[ ,]+/).filter(Boolean));
}
function chordToMidi(chord, octave=4){
  const m = chord.match(/^[A-G](#|b)?/); if(!m) return [];
  const root = m[0]; const quality = chord.slice(root.length).toLowerCase();
  const semitone = noteToSemitone[root];
  const base = 12*(octave+1) + semitone;
  let ints = [0,4,7];
  if(quality.startsWith('m') && !quality.startsWith('maj')) ints=[0,3,7];
  if(quality.includes('maj7')) ints=[0,4,7,11];
  if(quality.includes('m7')) ints=[0,3,7,10];
  if(quality==='7') ints=[0,4,7,10];
  if(quality.includes('sus2')) ints=[0,2,7];
  if(quality.includes('sus4')) ints=[0,5,7];
  if(quality.includes('9')) ints=[0,4,7,14];
  return ints.map(i=>base+i);
}
function midiToNoteName(midi){
  const oct = Math.floor(midi/12)-1; const nn = noteNames[midi%12]; return nn+oct;
}

// --- Tone / synth setup ---
let synth = null; // PolySynth
let master = null; // Gain node to route to recorder+destination
let recorder = null;
let part = null; // Tone.Part
let isLoop = false;
let isRecording = false;

function createSynth(preset){
  // dispose if exists
  if(synth){ synth.dispose(); master.dispose(); recorder=null; }
  // master gain
  master = new Tone.Gain(0.9).toDestination();
  // recorder attached to master
  recorder = new Tone.Recorder();
  master.connect(recorder);

  // poly synth of FMSynth
  const presetMap = {
    chip:{harmonicity:2.5,modulationIndex:14,oscillator:{type:'sine'},envelope:{attack:0.01,decay:0.2,sustain:0.7,release:0.4}},
    pad:{harmonicity:0.8,modulationIndex:6,oscillator:{type:'sine'},envelope:{attack:0.6,decay:1.2,sustain:0.6,release:1.4}},
    bass:{harmonicity:0.5,modulationIndex:18,oscillator:{type:'square'},envelope:{attack:0.01,decay:0.4,sustain:0.8,release:0.8}},
    piano:{harmonicity:1.2,modulationIndex:4,oscillator:{type:'triangle'},envelope:{attack:0.005,decay:0.3,sustain:0,release:0.3}},
    guitar:{harmonicity:3,modulationIndex:12,oscillator:{type:'square'},envelope:{attack:0.002,decay:0.25,sustain:0,release:0.2}},
    bell:{harmonicity:4,modulationIndex:40,oscillator:{type:'sine'},envelope:{attack:0.01,decay:2,sustain:0,release:1}}
  };
  let opts = Object.assign({}, commonOpts);
  if(preset==='chip') { opts.harmonicity = 2.5; opts.modulationIndex = 14; }
  if(preset==='pad')  { opts.harmonicity = 0.8; opts.modulationIndex = 6; opts.envelope = {attack:0.6,decay:1.2,sustain:0.6,release:1.4}; }
  if(preset==='bass') { opts.harmonicity = 0.5; opts.modulationIndex = 18; opts.envelope = {attack:0.01,decay:0.4,sustain:0.8,release:0.8}; }

  const opt = presetMap[preset] || presetMap.chip;
  synth = new Tone.PolySynth(Tone.FMSynth, opt).connect(master);
}

// --- Playback ---
function buildPart(){
  const prog = parseProg(document.getElementById('prog').value);
  const tempo = Number(document.getElementById('tempo').value) || 100;
  const octave = Number(document.getElementById('octave').value) || 4;
  const beatsPerChord = Number(document.getElementById('beats').value) || 1;

  // dispose old part
  if(part){ part.stop(); part.dispose(); part = null; }

  Tone.Transport.bpm.value = tempo;

  const events = [];
  prog.forEach((ch, i) => {
    const midiNotes = chordToMidi(ch, octave);
    if(midiNotes.length===0) return;
    const noteNames = midiNotes.map(m=>midiToNoteName(m));
    // compute transport time string: bars:quarters:sixteenths
    const beats = i * beatsPerChord; // counts of quarter-note beats from start
    const bars = Math.floor(beats / 4);
    const quarters = Math.floor(beats % 4);
    const timeStr = `${bars}:${quarters}:0`;
    events.push({time: timeStr, notes: noteNames, duration: beatsPerChord===1? '4n' : beatsPerChord===2? '2n':'1m'});
  });

  part = new Tone.Part((time, value) => {
    synth.triggerAttackRelease(value.notes, value.duration, time);
  }, events);

  // loop handling: set loopEnd to length in measures
  if(isLoop && events.length>0){
    // compute end bars
    const lastBeats = (events.length) * Number(document.getElementById('beats').value);
    const endBars = Math.ceil(lastBeats/4);
    part.loop = true; part.loopEnd = `${endBars}m`;
  } else {
    part.loop = false;
  }
}

async function startPlay(){
  await Tone.start();
  if(!synth) createSynth(document.getElementById('preset').value);
  buildPart();

  // --- auto 1-loop recording ---
  const shouldAutoRecord = true;
  let loopEndSec = 0;
  if(part){
    const bpm = Tone.Transport.bpm.value;
    const beatsPerChord = Number(document.getElementById('beats').value)||1;
    const totalChords = parseProg(document.getElementById('prog').value).length;
    const totalBeats = totalChords * beatsPerChord;
    loopEndSec = (60/bpm) * totalBeats;
  }

  if(shouldAutoRecord){
    recorder.start();
  }

  part.start(0);
  Tone.Transport.start();
  document.getElementById('play').disabled = true;

  if(shouldAutoRecord){
    setTimeout(async ()=>{
      const data = await recorder.stop();
      const url = URL.createObjectURL(data);
      document.getElementById('player').src = url;
      stopPlay();
    }, loopEndSec*1000);
  }
}
function stopPlay(){
  Tone.Transport.stop();
  if(part){ part.stop(); part.dispose(); part = null; }
  document.getElementById('play').disabled = false;
}

// --- MIDI export ---
function exportMIDI(){
  const prog = parseProg(document.getElementById('prog').value);
  const tempo = Number(document.getElementById('tempo').value) || 100;
  const octave = Number(document.getElementById('octave').value) || 4;
  const track = new MidiWriter.Track(); track.setTempo(tempo);
  prog.forEach(ch => {
    const midi = chordToMidi(ch, octave);
    if(midi.length===0) return;
    const names = midi.map(m=>midiToNoteName(m));
    track.addEvent(new MidiWriter.ChordEvent({pitch: names, duration: '4'}));
  });
  const writer = new MidiWriter.Writer(track);
  const blob = new Blob([writer.buildFile()], {type:'audio/midi'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'progression.mid'; a.click();
}

// --- Recorder (WAV) ---
async function startRecording(){
  if(!synth) createSynth(document.getElementById('preset').value);
  await Tone.start();
  recorder.start();
  isRecording = true;
  document.getElementById('rec').textContent = 'â–  éŒ²éŸ³ä¸­';
  startPlay();
}
async function stopRecording(){
  if(!isRecording) return;
  const recording = await recorder.stop(); // Blob
  const url = URL.createObjectURL(recording);
  document.getElementById('player').src = url;
  isRecording = false;
  document.getElementById('rec').textContent = 'â— éŒ²éŸ³';
  stopPlay();
}

// --- Prompt gen ---
function genPrompt(){
  const tempo = Number(document.getElementById('tempo').value)||100;
  const prog = document.getElementById('prog').value.trim();
  const preset = document.getElementById('preset').value;
  const mood = preset==='chip'? 'bright nostalgic':'lush and warm';
  const txt = `Instrumental retro-FM game track. Tempo ${tempo} BPM. Chord progression: ${prog}. Style: ${mood}, metallic FM bells, tight bass, loop-friendly. No vocals.`;
  document.getElementById('prompt').value = txt;
}

// --- Event wiring ---
document.getElementById('play').addEventListener('click', async ()=>{ try{ await startPlay(); }catch(e){ alert('å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸï¼š'+e.message); }});
document.getElementById('stop').addEventListener('click', ()=>stopPlay());
document.getElementById('midi').addEventListener('click', ()=>exportMIDI());
document.getElementById('rec').addEventListener('click', async ()=>{
  if(!isRecording) await startRecording(); else await stopRecording();
});
document.getElementById('gen').addEventListener('click', ()=>genPrompt());
document.getElementById('loop').addEventListener('click', ()=>{ isLoop = !isLoop; document.getElementById('loop').textContent = `ğŸ” ãƒ«ãƒ¼ãƒ—: ${isLoop? 'ON':'OFF'}`; try{ buildPart(); }catch(e){} });

// ensure presets recreate synth
document.getElementById('preset').addEventListener('change', ()=>{ if(synth){ synth.dispose(); synth=null; createSynth(document.getElementById('preset').value); }});

</script></body>
</html><!-- Added: Genre-based chord generator, SUNO prompt UI, piano roll, enhanced presets --><script>
// --- Expanded realistic presets (sample based fallback using simple wavetables) ---
// unified presetDefs
const presetDefs = {
  chip: { modIndex: 50, carrier: 'square', mod: 'sine' },
  pad: { modIndex: 10, carrier: 'sine', mod: 'triangle' },
  bass: { modIndex: 80, carrier: 'square', mod: 'square' },
  brightKeys: { modIndex: 30, carrier: 'triangle', mod: 'square' },
  hollowBell: { modIndex: 90, carrier: 'sine', mod: 'sine' },
  pianoReal: { modIndex: 15, carrier: 'triangle', mod: 'sine' },
  guitarPluck: { modIndex: 25, carrier: 'sine', mod: 'square' }
};

// --- Genre chord presets ---
const genrePresets = {
  citypop: ["Cmaj7", "E7", "Am7", "D9"],
  lofi: ["Cm7", "Fm7", "Bb7", "Abmaj7"],
  kpop: ["Bm", "G", "D", "A"],
  futurebass: ["F", "G", "Em7", "Am7"]
};

function applyGenre(genre) {
  const prog = genrePresets[genre];
  if (!prog) return;
  document.getElementById('chordInput').value = prog.join(' | ');
}

// --- SUNO prompt auto-generator ---
function generateSunoPrompt() {
  const prog = document.getElementById('chordInput').value;
  const preset = document.getElementById('presetSelect').value;
  const genre = document.getElementById('genreSelect').value;

  const prompt = `Instrumental track. Genre: ${genre}. Chord progression: ${prog}. Timbre based on ${preset}. Warm, clean, modern sound.`;

  document.getElementById('sunoPrompt').value = prompt;
}

// --- Simple piano roll visualization ---
function drawPianoRoll(notes){
  const canvas = document.getElementById('pianoRoll');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  if(!ctx) return;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawGrid();
  const pxPerBeat = 60;
  const noteHeight = 10;
  notes.forEach(n => {
    if(!n) return;
    const x = n.start * pxPerBeat;
    const w = n.duration * pxPerBeat;
    const y = (128 - n.midi) * noteHeight * 0.25;
    ctx.fillStyle = '#5599ee';
    ctx.fillRect(x, y, w, noteHeight);
    ctx.strokeStyle = '#003377';
    ctx.strokeRect(x, y, w, noteHeight);
  });
}(notes) {
  const canvas = document.getElementById('pianoRoll');
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const pxPerBeat = 80;
  const noteHeight = 12;

  notes.forEach((n,i) => {
    const x = n.start * pxPerBeat;
    const w = n.duration * pxPerBeat;
    const y = (128 - n.midi) * noteHeight * 0.25;
    ctx.fillStyle = '#66aaff';
    ctx.fillRect(x, y, w, noteHeight);
  });
}
</script><div style="margin-top:20px; padding:10px; background:#fafafa; border-radius:12px;">
  <label>Genre generator:</label>
  <select id="genreSelect" onchange="applyGenre(this.value)">
    <option value="citypop">City Pop</option>
    <option value="lofi">Lo-fi</option>
    <option value="kpop">K-POP</option>
    <option value="futurebass">Future Bass</option>
  </select>
</div><div style="margin-top:20px; padding:10px; background:#f0f9ff; border-radius:12px;">
  <label>SUNO Prompt Auto:</label>
  <textarea id="sunoPrompt" style="width:100%; height:70px"></textarea>
  <button onclick="generateSunoPrompt()">Generate Prompt</button>
</div><canvas id="pianoRoll" width="900" height="300" style="margin-top:20px; width:100%; background:#fff; border:1px solid #ddd;"></canvas>

<!-- EXTENDED FEATURES: Advanced piano roll, WAV export, more presets, SUNO arranger, song-structure generator --><script>
// ---- WAV EXPORT (instead of webm) ----
async function recordWavFromAudioBuffer(buffer) {
  const wavBuffer = audioBufferToWav(buffer);
  const blob = new Blob([wavBuffer], { type: 'audio/wav' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'loop.wav';
  a.click();
}

// ---- DAW-style piano roll improvements ----
function drawGrid() {
  const canvas = document.getElementById('pianoRoll');
  const ctx = canvas.getContext('2d');
  ctx.strokeStyle = '#ddd';
  for (let i=0;i<16;i++) {
    ctx.beginPath();
    ctx.moveTo(i*60, 0);
    ctx.lineTo(i*60, canvas.height);
    ctx.stroke();
  }
}

function drawPianoRoll(notes) {
  const canvas = document.getElementById('pianoRoll');
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawGrid();

  const pxPerBeat = 60;
  const noteHeight = 10;

  notes.forEach(n => {
    const x = n.start * pxPerBeat;
    const w = n.duration * pxPerBeat;
    const y = (128 - n.midi) * noteHeight * 0.25;
    ctx.fillStyle = '#5599ee';
    ctx.fillRect(x, y, w, noteHeight);
    ctx.strokeStyle = '#003377';
    ctx.strokeRect(x, y, w, noteHeight);
  });
}

// ---- Extended realistic presets ----
const presetDefsExtended = {
  stringsSoft: { modIndex: 5, carrier: 'sine', mod: 'triangle' },
  stringsWide: { modIndex: 15, carrier: 'triangle', mod: 'triangle' },
  synthLead:   { modIndex: 35, carrier: 'square', mod: 'sawtooth' },
  brassSynth:  { modIndex: 45, carrier: 'sawtooth', mod: 'square' }
};

// merge extended presets
for(const k in presetDefsExtended){ presetDefs[k] = presetDefsExtended[k]; }

// ---- SUNO arranger: auto-build full prompt with structural hints ----
function generateSunoArranged() {
  const prog = document.getElementById('chordInput').value;
  const genre = document.getElementById('genreSelect').value;
  const preset = document.getElementById('presetSelect').value;

  const arranged = `Instrumental track in ${genre} style. Song structure:
A-melody: light intro using ${preset}.
B-melody: expand harmonies.
Chorus: bright and energetic.
Chord progression: ${prog}.
Timbre warm, modern, clean.`;

  document.getElementById('sunoPrompt').value = arranged;
}

// ---- Song structure generator (Aâ†’Bâ†’Chorus) ----
const structPresets = {
  citypop: {
    A: ["Cmaj7", "E7"],
    B: ["Am7", "D9"],
    C: ["Fmaj7", "G13"]
  },
  lofi: {
    A: ["Cm7", "Fm7"],
    B: ["Bb7", "Abmaj7"],
    C: ["Gm7", "Cm7"]
  },
  kpop: {
    A: ["Bm", "G"],
    B: ["D", "A"],
    C: ["Em7", "F#sus4"]
  }
};

function buildStructure() {
  const g = document.getElementById('genreSelect').value;
  const s = structPresets[g];
  if (!s) return;
  const merged = [...s.A, ...s.B, ...s.C].join(' | ');
  document.getElementById('chordInput').value = merged;
}
</script><div style="margin-top:20px; padding:14px; background:#ffe8f0; border-radius:12px;">
  <button onclick="generateSunoArranged()">Generate Full SUNO Arrangement Prompt</button>
  <button onclick="buildStructure()">Auto Song Structure (Aâ†’Bâ†’Chorus)</button>
</div>
